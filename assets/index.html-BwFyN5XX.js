import{_ as i,c as a,a as n,o as e}from"./app-BPmJL-vo.js";const l={};function t(h,s){return e(),a("div",null,[...s[0]||(s[0]=[n(`<h2 id="_1-win2win-ssh-注意事项" tabindex="-1"><a class="header-anchor" href="#_1-win2win-ssh-注意事项"><span>1. Win2Win SSH 注意事项</span></a></h2><p>在配置<a href="https://docs.activitywatch.net/en/latest/remote-server.html#i-know-what-i-m-doing-how-can-i-set-it-up-anyway" target="_blank" rel="noopener noreferrer">ActivityWatch</a>时，遇到如下提示：</p><blockquote><p>This is intentionally incomplete documentation, you’re expected to figure the rest out yourself (and if you can’t, you probably shouldn’t try.)</p></blockquote><p>这一下激发了我的挑战欲……本来以为ssh配置很迅速，但期间因为<code>Add-WindowsCapability</code> 卡死和找不到<code>ssh-server</code>显示log的方法，以及权限上踩了坑，配置了很久，在此记录一下。</p><h3 id="_4-1-ssh-server安装推荐" tabindex="-1"><a class="header-anchor" href="#_4-1-ssh-server安装推荐"><span>4.1 ssh-server安装推荐</span></a></h3><ul><li>Windows 自带的添加系统功能选项非常之慢，而且由于内部使用C#实现，各种不稳 定，怒换choco <ul><li>(不推荐) <code>Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0</code></li></ul></li><li>强烈推荐使用 Chocolatey 安装 OpenSSH-Server <ul><li><code>choco install openssh --params=&#39;/SSHServerFeature&#39; -y</code></li><li><strong>日志路径明确</strong>：不像 Windows 自带的日志在 Event Viewer 中打谜语一般模糊 不清，choco 的日志清晰详细，方便查找。</li></ul></li></ul><h3 id="_4-2-防火墙配置" tabindex="-1"><a class="header-anchor" href="#_4-2-防火墙配置"><span>4.2 防火墙配置</span></a></h3><ul><li>放行必要的 <strong>端口</strong> 和 <strong>子网</strong> 即可，确保通信正常。</li></ul><div class="language-powershell line-numbers-mode" data-highlighter="shiki" data-ext="powershell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-powershell"><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">$</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Subnet</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.XX.0/24</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">$</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 22</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">$</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">RuleName</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Allow-SSH-192.168.XX.0-24</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 创建防火墙规则，允许入站流量</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">New-NetFirewallRule</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> \`</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">DisplayName </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">$</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">RuleName</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> \`</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Direction Inbound </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">\`</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Protocol TCP </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">\`</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">LocalPort </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">$</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Port</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> \`</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">RemoteAddress </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">$</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Subnet</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> \`</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Action Allow </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">\`</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Profile Any </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">\`</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Description </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">允许从 192.168.22.0/24 子网到本地端口 22 的 SSH 流量</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-服务端配置-server" tabindex="-1"><a class="header-anchor" href="#_4-3-服务端配置-server"><span>4.3 服务端配置 (Server)</span></a></h3><ol><li><strong><code>ssh_config</code> 配置调整</strong><ul><li>建议注释或移除 <code>Match Administrators</code> 段落，避免 <code>authorized_keys</code> 的默 认目录指向错误。</li><li>使用<code>DEBUG3</code>以便排查连接错误。</li></ul></li></ol><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-ini"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ListenAddress 192.168.XX.1 </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 这里是本机路由接口</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Port SERVER_PORT </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># SSH服务端口</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Logging</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">SyslogFacility LOCAL0</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">LogLevel VERBOSE</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Auth</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">MaxAuthTries 2</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">AllowUsers vmuser</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">AuthorizedKeysFile .ssh/authorized_keys</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">PasswordAuthentication no</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">PermitEmptyPasswords no</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">PermitRootLogin no</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">PubkeyAuthentication yes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#Forwarding</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">AllowAgentForwarding no</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">X11Forwarding no</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Subsystem       sftp    sftp-server.exe</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Match User user_name</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    AllowTcpForwarding yes</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    PermitTTY no</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    ForceCommand cmd.exe /c exit</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    PermitOpen 127.0.0.1:5600</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 强烈建议注释掉这里</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Match Group administrators</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#        AuthorizedKeysFile __PROGRAMDATA__/ssh/administrators_authorized_keys</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><p><strong><code>authorized_keys</code> 权限设置</strong><br> Windows 的 ACL 权限系统非常复杂，不能直接用 <code>chmod</code>，需要以下步骤：</p><ul><li>重新设置权限：<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>icacls authorized_keys /reset</span></span>
<span class="line"><span>icacls authorized_keys /inheritance:r</span></span>
<span class="line"><span>icacls authorized_keys /grant &lt;当前用户名&gt;:(F)</span></span>
<span class="line"><span>icacls authorized_keys /grant SYSTEM:(F)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>移除 NT Authorities 和其他用户的权限，确保只有当前用户和 SYSTEM。</li><li>注意：如果权限不正确，SSH Server 会拒绝加载 <code>authorized_keys</code>，需要到日 志中排查错误。</li></ul></li><li><p>排错日志路径是<code>C:\\ProgramData\\ssh\\logs\\sshd.log</code>，按如上方式启用DEBUG3级别 的log后，可以看到具体问题。</p></li></ol><h3 id="_4-4-客户端配置-client" tabindex="-1"><a class="header-anchor" href="#_4-4-客户端配置-client"><span>4.4 客户端配置 (Client)</span></a></h3><ul><li>客户端配置问题相对较少，按常规流程操作即可，无需额外调整。</li><li>以下是参考配置，提高安全性，不分配TTY，只做端口转发。</li></ul><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-ini"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Host aw-tunnel</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    HostName 192.168.XX.XX </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 服务器</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    User user_name </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 用户</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    Port XXX </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># SSH 服务端口</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    IdentityFile ~/.ssh/id_rsa  </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 替换为你的密钥路径</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    LocalForward 127.0.0.1:5600 127.0.0.1:5600</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    ExitOnForwardFailure yes</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    ServerAliveInterval 30</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    TCPKeepAlive yes</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    Compression yes</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    LogLevel QUIET</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完成后使用<code>ssh -N aw-tunnel</code>即可连接到主机。</p><h3 id="_4-5-独立用户" tabindex="-1"><a class="header-anchor" href="#_4-5-独立用户"><span>4.5 独立用户</span></a></h3><p>为提高安全性，可以新建普通用户专用于ssh.</p><div class="language-powershell line-numbers-mode" data-highlighter="shiki" data-ext="powershell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-powershell"><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">net user sshuser YourPassword </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">/</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">add</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>使用RunAs以不同用户身份运行程序:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>runas /user:用户名 cmd</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div>`,22)])])}const d=i(l,[["render",t]]),p=JSON.parse('{"path":"/notes/misc/win2win-ssh/","title":"Win2WinSSH","lang":"en-US","frontmatter":{"title":"Win2WinSSH","createTime":"2025/02/21 10:41:47","permalink":"/notes/misc/win2win-ssh/","description":"1. Win2Win SSH 注意事项 在配置ActivityWatch时，遇到如下提示： This is intentionally incomplete documentation, you’re expected to figure the rest out yourself (and if you can’t, you probably sho...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Win2WinSSH\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-02-21T10:32:27.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://saturntsen.github.io/notes/misc/win2win-ssh/"}],["meta",{"property":"og:site_name","content":"SaturnTsen"}],["meta",{"property":"og:title","content":"Win2WinSSH"}],["meta",{"property":"og:description","content":"1. Win2Win SSH 注意事项 在配置ActivityWatch时，遇到如下提示： This is intentionally incomplete documentation, you’re expected to figure the rest out yourself (and if you can’t, you probably sho..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2025-02-21T10:32:27.000Z"}],["meta",{"property":"article:modified_time","content":"2025-02-21T10:32:27.000Z"}]]},"readingTime":{"minutes":2.48,"words":744},"git":{"createdTime":1740133947000,"updatedTime":1740133947000,"contributors":[{"name":"SaturnTsen","username":"SaturnTsen","email":"minger233@outlook.com","commits":1,"avatar":"https://avatars.githubusercontent.com/SaturnTsen?v=4","url":"https://github.com/SaturnTsen"}]},"autoDesc":true,"filePathRelative":"notes/misc/Win2WinSSH.md","headers":[],"categoryList":[{"id":"4358b5","sort":10000,"name":"notes"},{"id":"133904","sort":10001,"name":"misc"}]}');export{d as comp,p as data};
